# Day 46: 3D Finite-Difference Time-Domain (FDTD) Simulation

**Objective:**
- **Simulate 3D Electromagnetic Wave Propagation on GPU:** Develop a CUDA C++ program to simulate the propagation of electromagnetic waves in three dimensions using the Finite-Difference Time-Domain (FDTD) method, accelerated by the GPU.
- **Understand the FDTD Method in 3D:** Learn the fundamental principles of the FDTD method for numerically solving Maxwell's equations in a three-dimensional space.
- **Implement CUDA for 3D Grid-Based Simulations:** Gain experience in using CUDA to perform parallel computations on a 3D grid, which is essential for simulating physical phenomena in three dimensions.
- **Model Source Injection and Wave Field Evolution:** Observe the numerical simulation of an electromagnetic wave generated by a source and its propagation through the simulation domain.

**Key Learnings:**
- **Finite-Difference Time-Domain (FDTD) Method in 3D:**
    - Understood the basic principles of the FDTD method, which involves discretizing both space and time and approximating the derivatives in Maxwell's equations using finite differences.
    - Learned about the Yee lattice, a staggered grid where the electric and magnetic field components are spatially and temporally offset, which is crucial for the accuracy and stability of the FDTD method.
- **CUDA Implementation for 3D Grids:**
    - Developed CUDA kernels (`update_h` and `update_e`) to update the magnetic (H) and electric (E) field components in parallel across the 3D grid.
    - Used a 3D grid of thread blocks and threads within each block to map the computational work to the GPU's parallel architecture.
    - Understood how to calculate the 1D index from 3D coordinates using the `IDX` macro for efficient memory access in the flattened arrays representing the 3D fields.
- **Update Equations for E and H Fields:**
    - Implemented the finite difference approximations of Faraday's law and Ampère-Maxwell's law in the `update_h` and `update_e` kernels, respectively. These equations describe how the electric and magnetic fields influence each other over time.
- **Time-Stepping Simulation:**
    - Implemented a time-stepping loop where the magnetic fields are updated based on the electric fields at the current time step, and then the electric fields are updated based on the newly computed magnetic fields. This leapfrog scheme is characteristic of the FDTD method.
- **Source Injection:**
    - Implemented a simple source injection mechanism (`inject_source` kernel) to introduce an electromagnetic wave into the simulation domain by adding a sinusoidal function to the Ez component at the center of the grid.
- **Boundary Conditions:**
    - Observed the implementation of simple boundary conditions in the `update_h` and `update_e` kernels, where the updates are skipped for grid points near the edges of the simulation domain. More advanced boundary conditions (like Perfectly Matched Layers - PML) are often used in real-world FDTD simulations to absorb outgoing waves and prevent reflections.

**Code Implementation Details:**

- **Includes:**
    - `cstdio`: Standard input/output library for functions like `printf`.
    - `cuda_runtime.h`: CUDA runtime API for interacting with the GPU.
- **Defines:**
    - `IDX(x, y, z, nx, ny)`: A macro to calculate the 1D index in the flattened array corresponding to the 3D coordinates (x, y, z) given the grid dimensions `nx` and `ny`.
    - `NX`, `NY`, `NZ`: Dimensions of the 3D grid in the x, y, and z directions.
    - `STEPS`: Number of time steps to simulate.
    - `DT`: Time step size.
    - `DX`: Spatial step size.
- **`update_h` Global Function:**
    - Updates the magnetic field components Hx, Hy, and Hz at each grid point (x, y, z) based on the values of the electric field components Ex, Ey, and Ez at the current time step.
    - Implements the finite difference approximation of Faraday's law.
    - Includes a boundary condition to prevent updates at the edges of the grid (specifically, the last layer in each dimension).
- **`update_e` Global Function:**
    - Updates the electric field components Ex, Ey, and Ez at each grid point (x, y, z) based on the values of the magnetic field components Hx, Hy, and Hz at the current time step.
    - Implements the finite difference approximation of Ampère-Maxwell's law.
    - Includes a boundary condition to skip updates at the edges of the grid (specifically, the first layer in each dimension).
- **`inject_source` Global Function:**
    - Injects a sinusoidal electromagnetic source into the Ez component at the center of the grid (`cx = nx / 2`, `cy = ny / 2`, `cz = nz / 2`). The source strength varies with time (`t`).
- **`main` Function:**
    - Defines the total number of grid points and allocates managed memory on the GPU for the six field components (Ex, Ey, Ez, Hx, Hy, Hz).
    - Initializes all field components to zero using `cudaMemset`.
    - Defines the thread block dimensions (8x8x8) and calculates the grid dimensions to cover the entire 3D simulation domain.
    - Records the start time using CUDA events.
    - Executes the main simulation loop for the specified number of time steps:
        - Calls the `update_h` kernel to update the magnetic fields.
        - Calls `cudaDeviceSynchronize()` to ensure the H field update is complete before updating the E field.
        - Calls the `update_e` kernel to update the electric fields.
        - Calls `cudaDeviceSynchronize()` again.
        - Calls the `inject_source` kernel to inject the source into the Ez field.
    - Records the stop time and calculates the total simulation time using CUDA events.
    - Prints the total simulation time.
    - Prints the final value of the Ez component at the center of the grid as a sample of the simulation result.
    - Frees the allocated memory on the GPU and destroys the CUDA events.

**Results:**
- FDTD completed in 7270.929 ms
- Final Ez at center: 8.377879